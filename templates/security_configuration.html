{% extends "base.html" %}

{% block title %}Security Configuration{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h2 class="mb-4">üîê Security Configuration</h2>
            
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Security Configuration Form -->
            <form method="POST" class="config-form">
                <input type="hidden" name="action" value="update">
                
                <!-- Password Policy -->
                <div class="config-section">
                    <div class="section-header">Password Policy</div>
                    <div class="section-content">
                        <div class="config-row">
                            <div class="config-item">
                                <label>Min Password Length</label>
                                <input type="number" class="form-control" name="config_password_min_length" 
                                       value="{{ configs.get('password_min_length', {}).get('value', 8) }}" min="6" max="20">
                            </div>
                            <div class="config-item">
                                <label>Password Expiration (Days)</label>
                                <input type="number" class="form-control" name="config_password_expiration_days" 
                                       value="{{ configs.get('password_expiration_days', {}).get('value', 90) }}" min="0">
                            </div>
                        </div>
                        <div class="config-checkboxes">
                            <div class="form-check-custom">
                                <input type="checkbox" id="pu" name="config_password_require_uppercase" value="true"
                                       {% if configs.get('password_require_uppercase', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="pu">Uppercase (A-Z)</label>
                            </div>
                            <div class="form-check-custom">
                                <input type="checkbox" id="pn" name="config_password_require_numbers" value="true"
                                       {% if configs.get('password_require_numbers', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="pn">Numbers (0-9)</label>
                            </div>
                            <div class="form-check-custom">
                                <input type="checkbox" id="ps" name="config_password_require_special" value="true"
                                       {% if configs.get('password_require_special', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="ps">Special Chars (!@#$%)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Security -->
                <div class="config-section">
                    <div class="section-header">Login Security</div>
                    <div class="section-content">
                        <div class="config-row">
                            <div class="config-item">
                                <label>Max Failed Attempts</label>
                                <input type="number" class="form-control" name="config_failed_login_attempts" 
                                       value="{{ configs.get('failed_login_attempts', {}).get('value', 5) }}" min="3" max="20">
                            </div>
                            <div class="config-item">
                                <label>Lockout Duration (Min)</label>
                                <input type="number" class="form-control" name="config_lockout_duration_minutes" 
                                       value="{{ configs.get('lockout_duration_minutes', {}).get('value', 15) }}" min="5" max="120">
                            </div>
                        </div>
                        <div class="config-checkboxes">
                            <div class="form-check-custom">
                                <input type="checkbox" id="sla" name="config_suspicious_login_alert" value="true"
                                       {% if configs.get('suspicious_login_alert', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="sla">Alert on Suspicious Login</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session & Authentication -->
                <div class="config-section">
                    <div class="section-header">Session & Authentication</div>
                    <div class="section-content">
                        <div class="config-row">
                            <div class="config-item">
                                <label>Session Timeout (Min)</label>
                                <input type="number" class="form-control" name="config_session_timeout_minutes" 
                                       value="{{ configs.get('session_timeout_minutes', {}).get('value', 30) }}" min="5" max="480">
                            </div>
                            <div class="config-item">
                                <label>API Rate Limit (/min)</label>
                                <input type="number" class="form-control" name="config_api_rate_limit" 
                                       value="{{ configs.get('api_rate_limit', {}).get('value', 100) }}" min="10" max="1000">
                            </div>
                        </div>
                        <div class="config-checkboxes">
                            <div class="form-check-custom">
                                <input type="checkbox" id="2fa" name="config_enable_2fa" value="true"
                                       {% if configs.get('enable_2fa', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="2fa">Enable 2FA</label>
                            </div>
                            <div class="form-check-custom">
                                <input type="checkbox" id="ev" name="config_enable_email_verification" value="true"
                                       {% if configs.get('enable_email_verification', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="ev">Email Verification</label>
                            </div>
                            <div class="form-check-custom">
                                <input type="checkbox" id="ipw" name="config_enable_ip_whitelist" value="true"
                                       {% if configs.get('enable_ip_whitelist', {}).get('value') == 'true' %}checked{% endif %}>
                                <label for="ipw">IP Whitelist</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit & Compliance -->
                <div class="config-section">
                    <div class="section-header">Audit & Compliance</div>
                    <div class="section-content">
                        <div class="config-row">
                            <div class="config-item">
                                <label>Audit Log Retention (Days)</label>
                                <input type="number" class="form-control" name="config_audit_log_retention_days" 
                                       value="{{ configs.get('audit_log_retention_days', {}).get('value', 180) }}" min="30" max="3650">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .config-form {
        max-width: 800px;
    }

    .config-section {
        margin-bottom: 25px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
    }

    .section-header {
        background-color: #3F4F5F;
        color: white;
        padding: 12px 18px;
        font-weight: 600;
        font-size: 14px;
    }

    .section-content {
        padding: 18px;
        background-color: #fafafa;
    }

    .config-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 18px;
    }

    .config-item label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
    }

    .config-item input[type="number"] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }

    .config-item input[type="number"]:focus {
        border-color: #3F4F5F;
        outline: none;
        box-shadow: 0 0 0 2px rgba(63, 79, 95, 0.15);
    }

    .config-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .form-check-custom {
        display: flex;
        align-items: center;
        font-size: 13px;
    }

    .form-check-custom input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        cursor: pointer;
        accent-color: #3F4F5F;
    }

    .form-check-custom label {
        cursor: pointer;
        margin: 0;
        user-select: none;
        color: #555;
        font-weight: 500;
    }

    .button-group {
        margin-top: 30px;
        display: flex;
        gap: 12px;
    }

    .btn {
        padding: 10px 24px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #3F4F5F;
        color: white;
    }

    .btn-primary:hover {
        background-color: #2d3a47;
        text-decoration: none;
        color: white;
    }

    .btn-secondary {
        background-color: #ddd;
        color: #333;
    }

    .btn-secondary:hover {
        background-color: #ccc;
        text-decoration: none;
        color: #333;
    }

    .alert {
        margin-bottom: 20px;
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .config-row {
            grid-template-columns: 1fr;
        }

        .config-checkboxes {
            flex-direction: column;
            gap: 12px;
        }
    }
</style>
{% endblock %}
