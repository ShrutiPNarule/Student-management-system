{% extends "base.html" %}
{% block content %}

{% if session.get("role") not in ["admin", "auditor", "superadmin", "clerk"] %}
    <h3 style="color:red;">Unauthorized Access</h3>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Go Back</a>

{% else %}

<div class="form-card">
    <h2>Search & Filter Students</h2>

    <form method="GET" novalidate>
        
        <h3>Search By</h3>
        <div class="form-row">
            <div class="form-group">
                <label>Student Name</label>
                <input
                    type="text"
                    name="search_name"
                    placeholder="Enter student name"
                    value="{{ request.args.get('search_name', '') }}"
                >
            </div>

            <div class="form-group">
                <label>Roll Number</label>
                <input
                    type="text"
                    name="search_roll"
                    placeholder="Enter roll number"
                    value="{{ request.args.get('search_roll', '') }}"
                >
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Email</label>
                <input
                    type="email"
                    name="search_email"
                    placeholder="Enter email"
                    value="{{ request.args.get('search_email', '') }}"
                >
            </div>

            <div class="form-group">
                <label>Phone</label>
                <input
                    type="text"
                    name="search_phone"
                    placeholder="Enter phone number"
                    value="{{ request.args.get('search_phone', '') }}"
                    pattern="[0-9]{10}"
                >
            </div>
        </div>

        <h3>Filter By</h3>
        <div class="form-row">
            <div class="form-group">
                <label>College</label>
                <input
                    type="text"
                    name="filter_college"
                    placeholder="Enter college name"
                    value="{{ request.args.get('filter_college', '') }}"
                >
            </div>

            <div class="form-group">
                <label>Category</label>
                <select name="filter_category">
                    <option value="">-- All Categories --</option>
                    <option value="General" {% if request.args.get('filter_category') == 'General' %}selected{% endif %}>General</option>
                    <option value="OBC" {% if request.args.get('filter_category') == 'OBC' %}selected{% endif %}>OBC</option>
                    <option value="SC" {% if request.args.get('filter_category') == 'SC' %}selected{% endif %}>SC</option>
                    <option value="ST" {% if request.args.get('filter_category') == 'ST' %}selected{% endif %}>ST</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>GPA Range</label>
                <input
                    type="number"
                    name="gpa_min"
                    placeholder="Min GPA"
                    min="0"
                    max="10"
                    step="0.1"
                    value="{{ request.args.get('gpa_min', '') }}"
                >
                <input
                    type="number"
                    name="gpa_max"
                    placeholder="Max GPA"
                    min="0"
                    max="10"
                    step="0.1"
                    value="{{ request.args.get('gpa_max', '') }}"
                >
            </div>

            <div class="form-group">
                <label>Sort By</label>
                <select name="sort_by">
                    <option value="name" {% if request.args.get('sort_by') == 'name' %}selected{% endif %}>Name</option>
                    <option value="roll_no" {% if request.args.get('sort_by') == 'roll_no' %}selected{% endif %}>Roll Number</option>
                    <option value="gpa" {% if request.args.get('sort_by') == 'gpa' %}selected{% endif %}>GPA</option>
                    <option value="created_at" {% if request.args.get('sort_by') == 'created_at' %}selected{% endif %}>Date Added</option>
                </select>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Search</button>
            <a href="{{ url_for('search_students') }}" class="btn btn-secondary">Clear Filters</a>
            <button type="button" class="btn btn-info" onclick="exportToCSV()">ðŸ“¥ Export Results</button>
        </div>
    </form>

    {% if results %}
    <div style="margin-top: 30px;">
        <h3>Search Results ({{ results|length }} students)</h3>
        <table border="1" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f5f5f5;">
                    <th>Name</th>
                    <th>Roll No</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>College</th>
                    <th>Category</th>
                    <th>GPA</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in results %}
                <tr>
                    <td>{{ student[1] }}</td>
                    <td>{{ student[2] }}</td>
                    <td>{{ student[4] }}</td>
                    <td>{{ student[3] }}</td>
                    <td>{{ student[5] }}</td>
                    <td>{{ student[15] }}</td>
                    <td>{{ student[11] }}</td>
                    <td>
                        <a href="{{ url_for('student_profile', student_id=student[0]) }}" class="btn btn-sm btn-info">View</a>
                        {% if session.get("role") in ["admin", "clerk", "superadmin"] %}
                            <a href="{{ url_for('update_student_data', student_id=student[0]) }}" class="btn btn-sm btn-warning">Edit</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
function exportToCSV() {
    const table = document.querySelector('table');
    if (!table) {
        alert('No results to export');
        return;
    }
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let row of rows) {
        let csvRow = [];
        const cols = row.querySelectorAll('td, th');
        
        for (let col of cols) {
            csvRow.push('"' + col.innerText + '"');
        }
        csv.push(csvRow.join(','));
    }
    
    const csvContent = csv.join('\n');
    const link = document.createElement('a');
    link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
    link.download = 'students_search_results.csv';
    link.click();
}
</script>

{% endif %}

{% endblock %}
