{% extends "base.html" %}

{% block content %}

<div class="section-header">
    <h2>Students</h2>

    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <!-- Search Bar -->
        <div class="search-group">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search by name, roll no, email..." 
                onkeyup="searchStudents()"
            >
        </div>

        <!-- Info Type Filter Dropdown -->
        <div class="filter-group">
            <label for="infoFilter">View:</label>
            <select id="infoFilter" onchange="filterColumns(this.value)">
                <option value="all">All Info</option>
                <option value="personal">Personal Info</option>
                <option value="school">School Marks</option>
                <option value="college">College Marks</option>
            </select>
        </div>
    </div>
</div>

{% if students %}
<div class="table-wrapper">
<table id="studentsTable">
    <thead>
        <tr>
            <th class="col-always">ID</th>
            <th class="col-always">Name</th>
            <th class="col-personal">Roll No</th>
            <th class="col-personal">College</th>
            <th class="col-personal">Category</th>
            <th class="col-personal">Phone</th>
            <th class="col-personal">Email</th>
            <th class="col-school">10th</th>
            <th class="col-school">12th</th>
            <th class="col-college">S1</th>
            <th class="col-college">S2</th>
            <th class="col-college">S3</th>
            <th class="col-college">S4</th>
            <th class="col-college">S5</th>
            <th class="col-college">S6</th>
            <th class="col-college">S7</th>
            <th class="col-college">S8</th>

            {% if session.get("role") in ["admin", "clerk", "superadmin"] %}
                <th class="col-always">Actions</th>
            {% endif %}
        </tr>
    </thead>

    <tbody>
        {% for s in students %}
        <tr>
            <td class="col-always">{{ s[0] }}</td>
            <td class="col-always">{{ s[1] }}</td>
            <td class="col-personal">{{ s[2] }}</td>
            <td class="col-personal">{{ s[6] }}</td>
            <td class="col-personal">{{ s[7] }}</td>
            <td class="col-personal">{{ s[4] }}</td>
            <td class="col-personal">{{ s[5] }}</td>
            <td class="col-school">{{ s[8] }}</td>
            <td class="col-school">{{ s[9] }}</td>
            <td class="col-college">{{ s[10] }}</td>
            <td class="col-college">{{ s[11] }}</td>
            <td class="col-college">{{ s[12] }}</td>
            <td class="col-college">{{ s[13] }}</td>
            <td class="col-college">{{ s[14] }}</td>
            <td class="col-college">{{ s[15] }}</td>
            <td class="col-college">{{ s[16] }}</td>
            <td class="col-college">{{ s[17] }}</td>

            {% if session.get("role") in ["admin", "clerk", "superadmin"] %}
            <td class="col-always actions-cell">
                <!-- Edit -->
                <a href="{{ url_for('update_student_data', student_id=s[0]) }}"
                   class="btn btn-secondary btn-sm">
                    Edit
                </a>

                <!-- Update Marks (Only for Clerk and Superadmin) -->
                {% if session.get("role") in ["clerk", "superadmin"] %}
                <a href="{{ url_for('update_marks', student_id=s[0]) }}"
                   class="btn btn-info btn-sm">
                    üìä Marks
                </a>

                <!-- Attendance (Only for Clerk and Superadmin) -->
                <a href="{{ url_for('attendance', student_id=s[0]) }}"
                   class="btn btn-success btn-sm">
                    üìã Attendance
                </a>

                <!-- Scholarship (Only for Clerk and Superadmin) -->
                <a href="{{ url_for('scholarship', student_id=s[0]) }}"
                   class="btn btn-warning btn-sm">
                    üéì Scholarship
                </a>

                <!-- Documents (Only for Clerk and Superadmin) -->
                <a href="{{ url_for('documents', student_id=s[0]) }}"
                   class="btn btn-info btn-sm">
                    üìÑ Documents
                </a>
                {% endif %}

                <!-- Soft Delete (Only for Admin and Superadmin) -->
                {% if session.get("role") in ["admin", "superadmin"] %}
                <a href="{{ url_for('delete_student_data', student_id=s[0]) }}"
                   class="btn btn-warning btn-sm">
                    üóëÔ∏è Delete
                </a>
                {% endif %}
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% else %}
<p>No student records found.</p>
{% endif %}

<script>
function searchStudents() {
    const searchInput = document.getElementById('searchInput');
    const filter = searchInput.value.toLowerCase();
    const table = document.getElementById('studentsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        
        // Search in: Name (index 1), Roll No (index 2), Email (index 5)
        const name = cells[1] ? cells[1].textContent.toLowerCase() : '';
        const rollNo = cells[2] ? cells[2].textContent.toLowerCase() : '';
        const email = cells[5] ? cells[5].textContent.toLowerCase() : '';

        if (name.includes(filter) || rollNo.includes(filter) || email.includes(filter)) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }

    // Show "no results" message if needed
    const noResultsMsg = document.getElementById('noSearchResults');
    if (visibleCount === 0 && filter !== '') {
        if (!noResultsMsg) {
            const msg = document.createElement('p');
            msg.id = 'noSearchResults';
            msg.textContent = 'No students found matching your search.';
            msg.style.color = '#666';
            msg.style.marginTop = '10px';
            table.parentNode.appendChild(msg);
        }
    } else if (noResultsMsg) {
        noResultsMsg.remove();
    }
}

function filterColumns(filterType) {
    const table = document.getElementById('studentsTable');
    const rows = table.querySelectorAll('tr');

    rows.forEach(row => {
        const cells = row.querySelectorAll('th, td');
        cells.forEach(cell => {
            // Check if cell has the class using classList.contains()
            const hasAlways = cell.classList.contains('col-always');
            const hasPersonal = cell.classList.contains('col-personal');
            const hasSchool = cell.classList.contains('col-school');
            const hasCollege = cell.classList.contains('col-college');
            
            if (filterType === 'all') {
                cell.style.display = '';
            } else if (filterType === 'personal') {
                if (hasAlways || hasPersonal) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            } else if (filterType === 'school') {
                if (hasAlways || hasSchool) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            } else if (filterType === 'college') {
                if (hasAlways || hasCollege) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            }
        });
    });
}
</script>

<style>
.search-group {
    display: flex;
    align-items: center;
}

.search-group input {
    padding: 10px 15px;
    border: 1px solid #c5cbe3;
    border-radius: 6px;
    font-size: 14px;
    background-color: #f4f6ff;
    width: 250px;
    transition: 0.2s;
}

.search-group input:hover {
    border-color: #0066cc;
}

.search-group input:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.15);
}

.search-group input::placeholder {
    color: #999;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-group label {
    margin: 0;
    font-weight: 600;
    color: #333;
}

.filter-group select {
    padding: 8px 12px;
    border: 1px solid #c5cbe3;
    border-radius: 6px;
    font-size: 14px;
    background-color: #f4f6ff;
    cursor: pointer;
    transition: 0.2s;
    position: relative;
    z-index: 100;
    pointer-events: auto;
    -webkit-appearance: auto;
    appearance: auto;
}

.filter-group select:hover {
    border-color: #0066cc;
}

.filter-group select:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.15);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 20px;
}
</style>

{% endblock %}
